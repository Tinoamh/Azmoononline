{% extends "base.html" %}
{% block title %}تعریف آزمون{% endblock %}
{% block body_class %}exam-define{% endblock %}
{% block extra_css %}
<style>
  *{box-sizing:border-box}
  body.exam-define{background:linear-gradient(180deg,#f5f8ff 0%, #eef3ff 100%)}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #dfe6fb;border-radius:16px;box-shadow:0 16px 28px rgba(58,108,244,0.12);padding:20px; overflow:hidden}
  .section{margin-top:16px}
  .title{color:#3A6CF4;font-weight:800;margin:0 0 12px 0}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f0f4ff;text-align:right}
  th.chk, td.chk{ text-align:center; width:90px }
  .banks{list-style:none;margin:0;padding:0;border:1px solid #eaf1ff;border-radius:12px}
  .bank-item{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #f0f4ff}
  .bank-item:last-child{border-bottom:none}
  .count{font-size:12px;color:#3A6CF4;border:1px solid #cfe3ff;background:#eef6ff;border-radius:999px;padding:2px 8px;margin-right:auto}
  .actions{display:flex;justify-content:center;margin-top:18px}
  .input{width:100%;height:40px;border:1.6px solid #cfe3ff;border-radius:10px;padding:8px 10px}
  .btn{padding:12px 24px;border-radius:12px;background:#3A6CF4;color:#fff;border:none;cursor:pointer;font-size:16px}
  .bank-item input[type="radio"]{width:16px;height:16px;accent-color:#22c55e}
  /* Select-all header control styling */
  .sel-all{display:inline-flex;align-items:center;justify-content:center;gap:8px;color:#3A6CF4;font-weight:700}
  .sel-all input[type="checkbox"]{width:16px;height:16px;accent-color:#3A6CF4}
</style>
{% endblock %}
{% block content %}
<div class="wrap">
  <form method="post" class="card">
    {% csrf_token %}
    {% if error_message %}
    <div style="background:#fee2e2; border:1px solid #ef4444; color:#b91c1c; padding:12px; border-radius:10px; margin-bottom:16px; text-align:center; font-weight:700;">
        {{ error_message }}
    </div>
    {% endif %}
    <div class="section">
      <h2 class="title">نام آزمون</h2>
      <input class="input" type="text" name="exam_name" placeholder="نام آزمون" />
    </div>
    <div class="section">
      <h2 class="title">انتخاب کلاس</h2>
      <select class="input" name="class_id" id="classSelect">
        <option value="">بدون کلاس (انتخاب دستی دانشجویان)</option>
        {% for c in classes %}
          <option value="{{ c.id }}" {% if selected_class_id == c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="section">
      <h2 class="title">دانشجویان</h2>
      <input id="studentSearch" class="input" type="text" placeholder="جستجوی نام یا نام خانوادگی">
      <table class="table">
        <thead>
          <tr>
            <th>نام</th>
            <th>نام خانوادگی</th>
            <th class="chk">
              <label class="sel-all" for="selectAllStudents">
                <input type="checkbox" id="selectAllStudents">
                <span>انتخاب همه</span>
              </label>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr class="student-row">
            <td>{{ s.first_name }}</td>
            <td>{{ s.last_name }}</td>
            <td class="chk"><input type="checkbox" name="student_ids" value="{{ s.id }}" /></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="section">
      <h2 class="title">لیست بانک سوالات</h2>
      <ul class="banks">
        {% for b in banks %}
          <li class="bank-item"><input type="radio" name="source_exam_id" value="{{ b.id }}"><span>{{ b.name }}</span> <span class="count">تعداد سوالات: {{ b.q_count|default:b.num_questions }}</span></li>
        {% empty %}
          <li class="bank-item" style="color:#6b7aa6">بانک سوالی موجود نیست</li>
        {% endfor %}
      </ul>
    </div>
    <div class="section">
      <h2 class="title">تعداد سوالات آزمون</h2>
      <input class="input" type="number" min="0" name="num_questions" value="0" />
    </div>
    <div class="section">
      <h2 class="title">مدت زمان آزمون (دقیقه)</h2>
      <input class="input" type="number" min="1" name="duration" value="60" required />
    </div>
    <div class="section">
      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div>
          <h2 class="title">تاریخ و ساعت شروع</h2>
          <input class="input" type="datetime-local" name="start_time" required />
        </div>
        <div>
          <h2 class="title">تاریخ و ساعت پایان</h2>
          <input class="input" type="datetime-local" name="end_time" required />
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" type="submit">ثبت</button>
    </div>
  </form>
</div>
<script>
  (function(){
    var sel = document.getElementById('classSelect');
    if(sel){
      sel.addEventListener('change', function(){
        var v = sel.value;
        var url = new URL(window.location.href);
        if(v) url.searchParams.set('class_id', v); else url.searchParams.delete('class_id');
        window.location.href = url.toString();
      });
    }
    var master = document.getElementById('selectAllStudents');
    var boxes = Array.prototype.slice.call(document.querySelectorAll('input[name="student_ids"]'));
    function syncMaster(){
      if(boxes.length===0){ master.checked=false; return; }
      master.checked = boxes.every(function(b){ return b.checked; });
      master.indeterminate = !master.checked && boxes.some(function(b){ return b.checked; });
    }
    if(master){
      master.addEventListener('change', function(){
        boxes.forEach(function(b){ b.checked = master.checked; });
      });
      boxes.forEach(function(b){ b.addEventListener('change', syncMaster); });
      syncMaster();
    }

    // Auto-set end_time: start_time + duration (minutes)
    function computeEndTime(){
      var durEl = document.querySelector('input[name="duration"]');
      var startEl = document.querySelector('input[name="start_time"]');
      var endEl = document.querySelector('input[name="end_time"]');
      if(!durEl || !startEl || !endEl) return;
      var dur = parseInt(durEl.value, 10);
      var startVal = startEl.value;
      if(!isNaN(dur) && dur > 0 && startVal){
        // startVal format: YYYY-MM-DDTHH:MM
        var d = new Date(startVal);
        if(!isNaN(d.getTime())){
          d.setMinutes(d.getMinutes() + dur);
          var yyyy = d.getFullYear();
          var mm = String(d.getMonth()+1).padStart(2,'0');
          var dd = String(d.getDate()).padStart(2,'0');
          var HH = String(d.getHours()).padStart(2,'0');
          var MM = String(d.getMinutes()).padStart(2,'0');
          endEl.value = yyyy + '-' + mm + '-' + dd + 'T' + HH + ':' + MM;
        }
      }
    }
    var durEl2 = document.querySelector('input[name="duration"]');
    var startEl2 = document.querySelector('input[name="start_time"]');
    if(durEl2) durEl2.addEventListener('input', computeEndTime);
    if(startEl2) startEl2.addEventListener('input', computeEndTime);
    // Initialize once in case defaults exist
    computeEndTime();

    var search = document.getElementById('studentSearch');
    if(search){
      var rows = Array.prototype.slice.call(document.querySelectorAll('.student-row'));
      search.addEventListener('input', function(){
        var q = search.value.trim().toLowerCase();
        rows.forEach(function(r){
          var t = (r.cells[0].textContent + ' ' + r.cells[1].textContent).toLowerCase();
          r.style.display = q === '' || t.indexOf(q) !== -1 ? '' : 'none';
        });
      });
    }
  })();
</script>
{% endblock %}
